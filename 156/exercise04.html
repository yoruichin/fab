<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="Yue Siew Chin">
    <link rel="icon" href="media/favicon.ico">

    <title>Fab Academy 2016 | Yue Siew Chin | Exercise 04</title>

    <!-- Bootstrap core CSS -->
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom styles for this template -->
    <link href="media/fabacademy.css" rel="stylesheet">
    
    <!-- 3D files viewer -->
    <script type="text/javascript" src="media/jsc3d_ie.min.js"></script>
	<script type="text/javascript" src="media/jsc3d.min.js"></script>
    <script type="text/javascript" src="media/jsc3d.webgl.js"></script>
    <script type="text/javascript" src="media/jsc3d.touch.js"></script>

    <!-- Just for debugging purposes. Don't actually copy these 2 lines! -->
    <!--[if lt IE 9]><script src="bootstrap/js/ie8-responsive-file-warning.js"></script><![endif]-->
    <script src="bootstrap/js/ie-emulation-modes-warning.js"></script>

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    
    <!-- Load the menu file -->
    <script>
	function menu() {
					  $('#exercises').load("exercises-menu.html");
					  $('#project').load("project-menu.html");
					  $('#cclicense').load("license.html");
					  }
	</script>

  </head>

  <body onload="menu()">

    <!-- Static navbar -->
    <nav class="navbar navbar-default navbar-static-top">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="index.html">Home</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="about.html">About</a></li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Exercises <span class="caret"></span></a>
              <ul id="exercises" class="dropdown-menu" role="menu">
              </ul>
            </li>
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Final Project <span class="caret"></span></a>
              <ul id="project" class="dropdown-menu" role="menu">
              </ul>
            </li>
            <li><a href="contact.html">Contact</a></li>
        </ul>
        </div><!--/.nav-collapse -->
      </div>
    </nav>

    <div class="container">
    	
	<!-- Insert your content here below! -->


     <h2><b>Exercise 04 Electronics Production</b></h2>
    
    <p><a href="http://archive.fabacademy.org/archives/2016/master/videos/02-17/index.html" target="_blank">
  <button type="button" class="btn btn-primary btn">This week's Lecture</button></a><br>

  <h3>Requirement</h3>
	
	<ol>
	 <li>
		Mill out a PCB for In-system Programmer (ISP)
	 </li>
	 <li>
		Solder the components onto the PCB board
	 </li>
	 <li>
		Program the board as an ISP
	 </li>
	</ol>
	<br>

  <h3>FabISP</h3>

  <p>The FabISP is an in-system programmer for AVR microcontrollers, designed for production within a FabLab. It allows you to program the microcontrollers on other boards you make.</p><br>

	<h3>Milling the PCB</h3>
	<p>
		First, download the board files, hello.ISP.44 <a href="http://academy.cba.mit.edu/classes/embedded_programming/hello.ISP.44.png" target="_blank">board</a>, <a href="http://academy.cba.mit.edu/classes/embedded_programming/hello.ISP.44.traces.png" target="_blank">traces</a>, <a href="http://academy.cba.mit.edu/classes/embedded_programming/hello.ISP.44.interior.png" target="_blank">interior</a> circuit board file</a> from <a href="http://academy.cba.mit.edu/classes/electronics_production/index.html" target="_blank">class site</a>.</p>

    <div class="container"><center>
    <img src="photo/04_hello.ISP.44.png" width="133"><img src="photo/04_hello.ISP.44.traces.png" width="133"><img src="photo/04_hello.ISP.44.interior.png" width="133"><br>
    <legend>hello.ISP.44.interior: 1149 x 2260 px | 22.99 x 45.21 mm<br>
    hello.ISP.44.traces: 1149 x 2260 px | 22.99 x 45.21 mm
    </legend></center></div>
    <br>

        
    There are a few ways to mill the PCB. Using <a href="http://fabmodules.org/" target="_blank">Fabmodule.org</a> seems to be the easiest way to mill the PCB, since it takes in PNG directly. Refer to <a href="http://academy.cba.mit.edu/classes/electronics_production/traces.mp4" target="_blank">this</a> and <a href="http://academy.cba.mit.edu/classes/electronics_production/interior.mp4" target="_blank">this</a> tutorial videos on how to mill the PCB using fabmodules. However, the machine my lab is a <a href="http://www.lpkf.com/products/rapid-pcb-prototyping/circuit-board-plotter/protomat-s103.htm" target="_blank">LKPF Protomat S103</a>, and requires to read Geber file. I found <a href="http://www.build-electronic-circuits.com/gerber-file/" target="_blank">this tutorial</a> very helpful.</p><br>

    <h4>To generate Gerber file from Eagle</h4>

    <p>In Eagle, open Board view. Import the bitmap format of the traces. Choose <b>File > CAM Processor</b>. This will open the CAM Processor tool that is used to generate the files. To simplify creating Gerber files, Eagle comes with a predefined job for this, and it is called <b>gerb274x.cam</b>. Select where you want to put the Gerber files by clicking on the “File” button and choosing a folder. Do this for all the tabs. Then click <b>Process Job</b>. This creates your Gerber files.To open it in the CAM Processor click <b>File > Open > Job</b>. We use the *.cmp (Copper, component side) and *.plc (Silk screen, component side) files to mill the board. </p><br>

    <div class="container"><center>
      <img src="photo/04_eagle_tobitmap.jpg" class="img-thumbnail" width="300"><img src="photo/04_eagle_01.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_02.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_07.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_08.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_09.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_10.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_11.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_eagle_12.jpg" class="img-thumbnail" width="300">
      <legend>Generating gerber file from Eagle</legend></center>
    </div><br><br>

    <div class="container"><center>
      <img src="photo/04_mill_01.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_mill_02.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_mill_03.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_mill_04.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_mill_05.jpg" class="img-thumbnail" width="300">
      <legend>Sending gerber files to LKPF Protomat S103 for milling and testing the board</legend></center>
    </div><br><br>

    <h3>Stuff Board</h3>

    <p>Based on the <a href="http://academy.cba.mit.edu/classes/embedded_programming/hello.ISP.44.png" target="_blank">schematic</a>, the components needed are:
      <ul>
        <img src="photo/04_hello.ISP.44.png" width="170" align="right" ><li>1x <a href="http://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=1&ved=0CCIQFjAA&url=http%3A//www.atmel.com/dyn/resources/prod_documents/doc8006.pdf&ei=--46T52mCYe62wWv0ZCtCg&usg=AFQjCNGOlt6q-mlk4OSX5vtxbZr9Pc7RMw" target="_blank">ATiny44 microcontroller</a></li>
        <li>1x 1uF capacitor</li>
        <li>2x 10pF capacitor</li>
        <li>2x 100 ohm resistor</li>
        <li>1x 499 ohm resistor</li>
        <li>1x 1K ohm resistor</li>
        <li>1x 10K ohm resistor</li>
        <li>1x 6pin header</li>
        <li>1x USB connector</li>
        <li>2x 0 ohm resistors as jumpers</li>
        <li>1x 20 mHz Crystal</li>
        <li>2x 3.3V Zener diode</li>
        <li>1x usb mini cable</li>
        <li>1x ribbon cable</li>
        <li>two 6 pin connectors</li>
      </ul>
    </p><br>

    <h4>Clip a ribbon cable</h4>

    <div class="container"><center>
      <img src="photo/04_ribboncable_01.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_ribboncable_02.jpg" class="img-thumbnail" width="300">
      <img src="photo/04_ribboncable_03.jpg" class="img-thumbnail" width="300">
      <legend>Clipping a ribbon cable for the board.</legend></center>
    </div><br><br>

    <h4>Solder Components</h4>

    <p>I washed the board with soap and rinsed. Then I soldered the mini USB header first because I was told that was the most difficult part. Indeed it was. I spent a whole day trying to do it correctly. Thanks to the support given by Fablab@SP, I was able to make 2 attempts at soldering the boards. The first was a failure because I had applied too much solder to the connectors. The 2nd time I was conscious to apply less solder to my joints, and I was quite happy with myself. The learning curve is sure very steep, from reading schematic to circuit design to soldering and testing, but the result was satisfying.</p>

    <p class="pic"><img src="photo/04_soldering_01.jpg" width="400">
      <img src="photo/04_soldering_03.jpg" width="400">
  <legend>The fine connections were very hard to solder properly.</legend></p>

  <p>Things to take note during soldering:
    <ul>
      <li>Temperature must be hot enough. The solder should melt when come in contact with the hot iron.</li>
      <li>Smearing flux onto the PCB board during soldering is important to reduce the oxide on the board. What the flux does, when you heat a workpiece, is it reacts with these metal oxides that are forming with the temperature and exposure to the air, that tend to interfere with the metal-forming process of soldering. So this chemically reacts with these oxides, and makes for a nice, clean metal that can then form a nice, perfect alloy.</li>
      <li>Soldering wick is very useful to soak up excess, unwanted solder from the board.</li>
      <li>Be careful not to create unintentional solder short circuits with adjacent joints. That was my main problem because I used too much solder.</li>
    </ul></p>

 
    <p class="pic"><img src="photo/04_soldering_05.jpg" width="400">
  <legend>I was able to be more careful with the quantity of solder at the 2nd attempt.</legend></p><br>

  <h3>Testing the device</h3>

  <p>Do the "Smoke Test". Plug the FabISP into your computer via the mini USB cable. If you get an error message from your computer that the board is drawing too much power and that the computer is shutting down the USB port, you have a short somewhere on your board. If you do not receive any message, proceed to "Install the necessary software for AVR programming."</p>

  <p class="pic"><img src="photo/04_soldering_04.jpg" width="400">
  <legend>Testing the joints to check for short circuits with a multimeter.</legend></p> 

  <h3>Troubleshooting Short Circuits</h3>
    <ol>
      <li>Do a visual inspection of the board and reflow any solder joints that look cold (not shiny and smooth).</li>
      <li>Use a multimeter and check all the connections against each component to make sure that power and ground are not connected. Also check that there is no short on the power line.</li>
    </ol><br>


  <h3>FabISP Programming</h3>

  <p>I am required to create a FabISP from the PCB board I have soldered. One way is to have another FabISP or a commercial ISP to program it. An Arduino UNO can be used for this task. But I do not have a spare board that can do that. My classmate was able to successfully program his board, so I could use his as my programmer.</p>

  <p class="pic"><img src="photo/04_fabisp_firmware_01.jpg" width="400">
  <legend>Using the FabISP as a programmer to program another microcontroller.</legend></p>

<p><b>Avrdude -h</b> is very helpful to know the command lines to use to programme the microcontroller.</p>

<pre class="prettyprint linenums">
C:\WinAVR\bin>avrdude  -h
avrdude: unknown option -- h
Usage: avrdude [options]
Options:
  -p &ltpartno>                Required. Specify AVR device.
  -b &ltbaudrate>              Override RS-232 baud rate.
  -B &ltbitclock>              Specify JTAG/STK500v2 bit clock period (us).
  -C &ltconfig-file>           Specify location of configuration file.
  -c &ltprogrammer>            Specify programmer type.
  -D                         Disable auto erase for flash memory
  -i &ltdelay>                 ISP Clock Delay [in microseconds]
  -P &ltport>                  Specify connection port.
  -F                         Override invalid signature check.
  -e                         Perform a chip erase.
  -O                         Perform RC oscillator calibration (see AVR053).
  -U &ltmemtype>:r|w|v:<filename>[:format]
                             Memory operation specification.
                             Multiple -U options are allowed, each request
                             is performed in the order specified.
  -n                         Do not write anything to the device.
  -V                         Do not verify.
  -u                         Disable safemode, default when running from a script.
  -s                         Silent safemode operation, will not ask you if
                             fuses should be changed back.
  -t                         Enter terminal mode.
  -E &ltexitspec>[,&ltexitspec>] List programmer exit specifications.
  -x &ltextended_param>        Pass <extended_param> to programmer.
  -y                         Count # erase cycles in EEPROM.
  -Y &ltnumber>                Initialize erase cycle # in EEPROM.
  -v                         Verbose output. -v -v for more.
  -q                         Quell progress output. -q -q for less.
  -?                         Display this usage.
  </pre>

  <p>We have to edit the Make file to such:</p>
  <pre class="prettyprint linenums">
    AVRDUDE = avrdude -c usbtiny -p $(DEVICE) # edit this line for your programmer
    #AVRDUDE = avrdude -c avrisp2 -P usb -p $(DEVICE) # edit this line for your programmer
  </pre>

  Compile the firmware using:
  <pre class="prettyprint linenums">
    make clean
  </pre>

  <p>The commands used on avrdude are:</p>
  <pre class="prettyprint linenums">
    avrdude -v -v -c usbtiny -p t44 -e #perform a chip erase
    avrdude -v -v -c usbtiny -p t44 -U lfuse:w:0xff:m -U hfuse:w:0xdf:m -U flash:w:main.hex:i #load main.hex to chip
  </pre>

  <h3>Verify the ISP is working properly</h3>

  <p>With the help of my classmates and instructor, I was able to load the firmware onto my FabISP. Windows 10 is able to recognize it as USBtiny.It is hard to be entirely sure that the board is working properly as there is not indication to show that. Some of my classmates occasionally face the problem of unrecognized device even after the firmware has been loaded into the chip successfully. It could be poor connection or soldering. We don't know for sure.</p>

  <p class="pic"><img src="photo/04_fabisp_firmware_02.jpg" width="500">
  <legend>Download the USBtiny driver and update driver after the OS detected the device as "FabISP".</legend></center></p>

  <h3>Removing the jumpers</h3>

  <p>After the firmware was loaded to the microcontroller, we have to remove the SJ1 to prevent further writing onto the chip. We also remove the 0 ohm resister SJ2 to prevent electrical flow. Now we can use this as a programmer to program other boards. </p>

  <p class="pic"><img src="photo/04_soldering_06.jpg" width="400">
  <legend>Use soldering iron to remove the jumpers</legend></p>

  <p class="pic"><img src="photo/04_fabisp_casing.jpg" width="400">
  <legend>Designed and 3D-printed a case for my FabISP.</legend></p>

  <h3>Download workfiles</h3>
  <ul>
      <li><a href="workfiles/wk4/isp case top.123dx" target="_blank">isp case top.123dx</a></li>
      <li><a href="workfiles/wk4/isp case bottom.123dx" target="_blank">isp case bottom.123dx</a></li>
    </ul><br>


  <h3>References</h3>
  <ul>
    <li><a href="http://www.build-electronic-circuits.com/gerber-file/" target="_blank">How To Create a Gerber File Using Eagle</a></li>
    <li><a href="http://archive.fabacademy.org/archives/2016/doc/electronics_production_FabISP.html" target="_blank">FabISP: Electronics Production</a></li>
    <li><a href="https://www.youtube.com/watch?v=bGckVJeG6b8" target="_blank">What Is Flux? | Soldering</a></li>
    <li><a href="http://makezine.com/2016/02/19/learn-simple-surface-mount-soldering-in-collins-lab/" target="_blank">Learn Simple Surface Mount Soldering in Collin’s Lab</a></li>
    <li><a href="https://learn.adafruit.com/adafruit-guide-excellent-soldering/common-problems" target="_blank">Common Soldering Problems</a></li>  
    <li><a href="http://www.epectec.com/pcb/defects/solder_shorts.html" target="_blank">Solder Shorts on a Printed Circuit Board</a></li>
    <li><a href="http://archive.fabacademy.org/archives/2016/doc/programming_FabISP.html" target="_blank">FabISP: Programming</a></li> 
    <li><a href="http://archive.fabacademy.org/archives/2016/doc/arduinoisp.html" target="_blank">Arduino as an ISP</a></li> 
    <li><a href="https://learn.adafruit.com/usbtinyisp/avrdude" target="_blank">AVRDUDE - Using the programmer with AVRDUDE</a></li> 
    <li><a href="http://fab.cba.mit.edu/content/projects/fabisp/" target="_blank">FabISP, a fab-able in-system programmer</a></li> 
    <li><a href="http://www.engbedded.com/fusecalc" target="_blank">Engbedded Atmel AVR® Fuse Calculator</a></li> 
    

    <!-- End of your content -->

    </div> <!-- /container -->

	<!-- footer -->
    
    <footer id="footer">
        <p id="cclicense">
                </p>
        <p class="license">
        Theme: <a href="https://github.com/openp2pdesign/FabAcademy_Template">Fab Academy Template</a> by <a href="http://openp2pdesign.org">Massimo Menichinelli</a> <br>
        Based on <a href="http://getbootstrap.com/">Twitter Bootstrap</a>+<a href="http://jquery.com/">JQuery</a>+<a href="https://code.google.com/p/google-code-prettify/">google-code-prettify</a>+<a href="http://jmblog.github.io/color-themes-for-google-code-prettify/github/">GitHub theme for google-code-prettify</a>+<a href="https://code.google.com/p/jsc3d/">JSC3D</a>+<a href="https://github.com/thegrubbsian/jquery.ganttView">jquery.ganttView</a>.
        </p>
    </footer>
    

	<!-- Do not touch this! -->
    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="media/jquery-1.9.1.min.js"></script>
    
    <!-- Syntax Highlighter -->
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js">
    </script>
    <!-- From https://github.com/jmblog/color-themes-for-google-code-prettify -->
    <link href="media/github.css" type="text/css" rel="stylesheet">
	<script type="text/javascript">
	  !function ($) {
		$(function(){
		  window.prettyPrint && prettyPrint()   
		})
	  }(window.jQuery)
	</script>
	
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="bootstrap/js/ie10-viewport-bug-workaround.js"></script>

  </body>
</html>
